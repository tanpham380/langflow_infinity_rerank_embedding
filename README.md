# Infinity Components for Langflow

**Switch Language:** [English](#english-version) | [Tiếng Việt](#phiên-việt)

## <a name="english-version"></a>English Version

### Overview

This project provides two custom components for Langflow that integrate with the [Infinity API](https://github.com/michaelfeil/infinity) to enable document reranking and text embedding functionalities. These components are designed to interact with a locally deployed Infinity API instance (using Docker).

**Key Features:**

*   **Infinity Rerank Component:** Reranks a set of documents based on a given query using a cross-encoder model.  It makes calls to a locally deployed Infinity API to perform the ranking and returns the top-ranked results.  Error handling is included for invalid model names.
*   **Infinity Embeddings Component (with UI Integration):** Generates embeddings for input text using the Infinity API. If no specific model is provided, the component intelligently selects a suitable embedding-capable model from the API's available models. The UI component allows users to input parameters such as the API URL, model name, and authentication token.

### Component Details

#### A. Infinity Rerank Component

*   **Display Name:** Local Infinity Rerank
*   **Description:** Ranks documents based on a query by calling the Infinity API.  This component includes health checks for the API, model validation, calls to the `/rerank` endpoint, and sorting of results based on relevance scores.
*   **Icon:** Infinity
*   **Documentation:** [Infinity API Documentation](https://github.com/michaelfeil/infinity)

**Inputs:**

*   `query` (MessageTextInput): The query string used to rank the documents.
    *   Default: "What is FPT?"
*   `documents` (DataInput): A list of documents to be ranked.
*   `api_url` (StrInput): The base URL of the Infinity API endpoint.
    *   Example: `http://rerank-embeding-jinaai:7997/`
*   `model_name` (StrInput):  (Optional) The name of the model to use for reranking.
*   `number_of_rerank_return` (IntInput): The number of top-ranked documents to return.
    *   Default: 3

**Outputs:**

*   `top_ranked_document` (Output): A list of the top-ranked documents, represented as `Data` objects.

**Key Functions:**

*   `_check_health`:  Performs a health check on the Infinity API, incorporating a retry mechanism using the `tenacity` library.
*   `get_valid_model`: Retrieves the list of available models from the API and validates the provided `model_name`. If no model name is given, it returns the first model with the "rerank" capability.
*   `ranking_function`:  Makes a call to the `/rerank` API endpoint, passing the query, documents, model, and the desired number of results. It then processes the JSON response.
*   `rank_documents`: Integrates the validation and sorting steps to produce the final list of top-ranked documents.

#### B. Infinity Embeddings Component & UI

*   **Display Name (UI):** Local Infinity Embeddings
*   **Description:** Generates text embeddings and can also perform reranking by interacting with the Infinity API. If no model is specified, it automatically selects a model with embedding capabilities.
*   **Icon:** Infinity
*   **Documentation:** [Infinity API Documentation](https://github.com/michaelfeil/infinity)

**Inputs:**

*   `api_url` (StrInput): The URL of the Infinity API.
    *   Default: `"http://rerank-embeding-jinaai:7997"`
*   `model_name` (StrInput): (Optional) The name of the model to use. The component verifies if the model exists.
*   `auth_token` (StrInput): (Optional) An authentication token for the API (advanced usage).

**Outputs:**

*   `embeddings` (Output): The text embeddings generated by the Infinity API.

**Key Functions:**

*   `build_embeddings` (UI method): Validates the provided model name against the API. If no model name is provided, the backend component automatically selects an appropriate model.
*   `InfinityEmbeddingsComponent` (backend):
    *   `_check_health`: Checks the health of the Infinity API.
    *   `get_available_models` & `auto_select_model`:  Retrieves the list of available models and selects a model with the "embed" capability if no model is specified.
    *   `_embed`, `embed_documents`, `embed_query`:  Calls the `/embeddings` endpoint of the Infinity API to generate embeddings.

### Backend Deployment Instructions

To utilize these components, you need to deploy the Infinity API backend. You can do this using either Docker (command line) or Docker Compose.

#### A. Using Docker (Command Line)

Execute the following command:

```bash
docker run -it --gpus all \
  -v $PWD/data:/app/.cache \
  -p 7997:7997 \
  michaelf34/infinity:latest v2 \
  --model-id jinaai/jina-reranker-v2-base-multilingual \
  --model-id jinaai/jina-embeddings-v3 \
  --port 7997
```

**Details:**

*   **Port:** `7997` (This is the port the API will listen on.)
*   **Model 1:** `jinaai/jina-reranker-v2-base-multilingual` (Used for reranking.)
*   **Model 2:** `jinaai/jina-embeddings-v3` (Used for generating embeddings.)
*   **Volume:** Mounts the `data` folder in your current working directory (`$PWD/data`) to `/app/.cache` inside the container.  This allows the models to be cached and reused.
*  **--gpus all**: Enables the container used all GPUs

#### B. Using Docker Compose

1.  Create a file named `docker-compose.yml` in your project directory.
2.  Paste the following content into the `docker-compose.yml` file:

```yaml
version: '3.8'
services:
  rerank-embeding-jinaai:
    image: michaelf34/infinity:latest
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0', '1']  # Specify which GPUs to use (e.g., '0', '1')
              capabilities: [gpu]
    environment:
      - TZ=Asia/Ho_Chi_Minh  # Set the timezone (optional)
    ports:
      - "7997:7997"
    env_file:
      - .env  # Load environment variables from a .env file (optional)
    networks:
      - langflow
    volumes:
      - ./data:/app/.cache
    command: ["v2", "--model-id", "jinaai/jina-reranker-v2-base-multilingual",
              "--model-id", "jinaai/jina-embeddings-v3", "--port", "7997"]

networks:
  langflow:
    driver: bridge
```
3. Run `docker-compose up -d` in the directory with `docker-compose.yml`. The `-d` runs in detached mode.

**Important Notes for Docker Compose:**

*   **`device_ids`:**  Modify the `device_ids` under the `deploy` section to match the GPUs available on your system.  If you only have one GPU, use `device_ids: ['0']`.  If you don't want to use GPUs, remove the entire `deploy` section.
*   **`.env` file (optional):**  You can create a `.env` file in the same directory as your `docker-compose.yml` to store environment variables. This is useful for sensitive information like API keys.
*  **networks**: Setting up a network named `langflow` allows for easier communication between containers if you have other services running that need to interact with the Infinity API.

### References

*   **Infinity API Documentation:** [https://github.com/michaelfeil/infinity](https://github.com/michaelfeil/infinity)
*   **Langflow Custom Components Documentation:** [https://docs.langflow.org/components-custom-components](https://docs.langflow.org/components-custom-components)

---

## <a name="phiên-việt"></a>Phiên bản tiếng Việt

### Tổng quan

Dự án này cung cấp hai component tùy chỉnh (custom component) cho Langflow, tích hợp với [API Infinity](https://github.com/michaelfeil/infinity) để cung cấp chức năng xếp hạng lại tài liệu (rerank) và tạo embedding cho văn bản. Các component này được thiết kế để tương tác với một phiên bản API Infinity được triển khai cục bộ (sử dụng Docker).

**Các tính năng chính:**

*   **Infinity Rerank Component:** Xếp hạng lại một tập hợp các tài liệu dựa trên một truy vấn cho trước, sử dụng mô hình cross-encoder. Component này gọi API Infinity đã được triển khai cục bộ để thực hiện việc xếp hạng và trả về các kết quả được xếp hạng hàng đầu.  Có xử lý lỗi cho các tên model không hợp lệ.
*   **Infinity Embeddings Component (với tích hợp UI):** Tạo embedding cho văn bản đầu vào bằng cách sử dụng API Infinity. Nếu không có model cụ thể nào được cung cấp, component sẽ tự động chọn một model có khả năng tạo embedding phù hợp từ danh sách các model có sẵn của API. Component UI cho phép người dùng nhập các tham số như URL API, tên model và token xác thực.

### Chi tiết Component

#### A. Infinity Rerank Component

*   **Display Name:** Local Infinity Rerank
*   **Mô tả:** Xếp hạng tài liệu dựa trên truy vấn bằng cách gọi API Infinity. Component này bao gồm kiểm tra trạng thái của API, xác thực model, gọi đến endpoint `/rerank`, và sắp xếp kết quả dựa trên điểm số liên quan.
*   **Icon:** Infinity
*   **Documentation:** [Tài liệu API Infinity](https://github.com/michaelfeil/infinity)

**Inputs:**

*   `query` (MessageTextInput): Chuỗi truy vấn được sử dụng để xếp hạng tài liệu.
    *   Mặc định: "What is FPT?"
*   `documents` (DataInput): Danh sách các tài liệu cần được xếp hạng.
*   `api_url` (StrInput): URL cơ sở của endpoint API Infinity.
    *   Ví dụ: `http://rerank-embeding-jinaai:7997/`
*   `model_name` (StrInput): (Tùy chọn) Tên của model sẽ sử dụng để xếp hạng lại.
*   `number_of_rerank_return` (IntInput): Số lượng tài liệu được xếp hạng hàng đầu cần trả về.
    *   Mặc định: 3

**Outputs:**

*   `top_ranked_document` (Output): Danh sách các tài liệu được xếp hạng hàng đầu, được biểu diễn dưới dạng các đối tượng `Data`.

**Các hàm chính:**

*   `_check_health`: Thực hiện kiểm tra trạng thái của API Infinity, kết hợp cơ chế thử lại (retry) bằng thư viện `tenacity`.
*   `get_valid_model`: Lấy danh sách các model có sẵn từ API và xác thực `model_name` được cung cấp. Nếu không có tên model nào được cung cấp, nó trả về model đầu tiên có khả năng "rerank".
*   `ranking_function`: Thực hiện lời gọi đến endpoint `/rerank` của API, truyền vào truy vấn, tài liệu, model và số lượng kết quả mong muốn. Sau đó, nó xử lý phản hồi JSON.
*   `rank_documents`: Tích hợp các bước xác thực và sắp xếp để tạo ra danh sách cuối cùng các tài liệu được xếp hạng hàng đầu.

#### B. Infinity Embeddings Component & UI

*   **Display Name (UI):** Local Infinity Embeddings
*   **Mô tả:** Tạo embedding cho văn bản và cũng có thể thực hiện xếp hạng lại bằng cách tương tác với API Infinity. Nếu không có model nào được chỉ định, nó sẽ tự động chọn một model có khả năng tạo embedding.
*   **Icon:** Infinity
*   **Documentation:** [Tài liệu API Infinity](https://github.com/michaelfeil/infinity)

**Inputs:**

*   `api_url` (StrInput): URL của API Infinity.
    *   Mặc định: `"http://rerank-embeding-jinaai:7997"`
*   `model_name` (StrInput): (Tùy chọn) Tên của model sẽ sử dụng. Component sẽ xác minh xem model có tồn tại hay không.
*   `auth_token` (StrInput): (Tùy chọn) Token xác thực cho API (sử dụng nâng cao).

**Outputs:**

*   `embeddings` (Output): Các embedding văn bản được tạo bởi API Infinity.

**Các hàm chính:**

*   `build_embeddings` (phương thức UI): Xác thực tên model được cung cấp với API. Nếu không có tên model nào được cung cấp, component backend sẽ tự động chọn một model thích hợp.
*   `InfinityEmbeddingsComponent` (backend):
    *   `_check_health`: Kiểm tra trạng thái của API Infinity.
    *   `get_available_models` & `auto_select_model`: Lấy danh sách các model có sẵn và chọn một model có khả năng "embed" nếu không có model nào được chỉ định.
    *   `_embed`, `embed_documents`, `embed_query`: Gọi endpoint `/embeddings` của API Infinity để tạo embedding.

### Hướng dẫn Triển khai Backend

Để sử dụng các component này, bạn cần triển khai backend API Infinity.  Bạn có thể thực hiện việc này bằng Docker (command line) hoặc Docker Compose.

#### A. Sử dụng Docker (Command Line)

Chạy lệnh sau:

```bash
docker run -it --gpus all \
  -v $PWD/data:/app/.cache \
  -p 7997:7997 \
  michaelf34/infinity:latest v2 \
  --model-id jinaai/jina-reranker-v2-base-multilingual \
  --model-id jinaai/jina-embeddings-v3 \
  --port 7997
```

**Chi tiết:**

*   **Port:** `7997` (Đây là cổng mà API sẽ lắng nghe.)
*   **Model 1:** `jinaai/jina-reranker-v2-base-multilingual` (Được sử dụng để xếp hạng lại.)
*   **Model 2:** `jinaai/jina-embeddings-v3` (Được sử dụng để tạo embedding.)
*   **Volume:** Gắn thư mục `data` trong thư mục làm việc hiện tại của bạn (`$PWD/data`) vào `/app/.cache` bên trong container.  Điều này cho phép các model được lưu vào bộ nhớ cache và sử dụng lại.
*  **--gpus all**: Cho phép container sử dụng tất cả các GPU có sẵn.

#### B. Sử dụng Docker Compose

1.  Tạo một tệp có tên `docker-compose.yml` trong thư mục dự án của bạn.
2.  Dán nội dung sau vào tệp `docker-compose.yml`:

```yaml
version: '3.8'
services:
  rerank-embeding-jinaai:
    image: michaelf34/infinity:latest
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0', '1']  # Chỉ định GPU nào sẽ sử dụng (ví dụ: '0', '1')
              capabilities: [gpu]
    environment:
      - TZ=Asia/Ho_Chi_Minh  # Đặt múi giờ (tùy chọn)
    ports:
      - "7997:7997"
    env_file:
      - .env  # Tải các biến môi trường từ tệp .env (tùy chọn)
    networks:
      - langflow
    volumes:
      - ./data:/app/.cache
    command: ["v2", "--model-id", "jinaai/jina-reranker-v2-base-multilingual",
              "--model-id", "jinaai/jina-embeddings-v3", "--port", "7997"]

networks:
  langflow:
    driver: bridge
```
3. Chạy `docker-compose up -d` trong thư mục chứa file `docker-compose.yml`. Tham số `-d` chạy ở chế độ detached.

**Lưu ý quan trọng cho Docker Compose:**

*   **`device_ids`:** Sửa đổi `device_ids` trong phần `deploy` để khớp với các GPU có sẵn trên hệ thống của bạn. Nếu bạn chỉ có một GPU, hãy sử dụng `device_ids: ['0']`. Nếu bạn không muốn sử dụng GPU, hãy xóa toàn bộ phần `deploy`.
*   **Tệp `.env` (tùy chọn):** Bạn có thể tạo một tệp `.env` trong cùng thư mục với `docker-compose.yml` để lưu trữ các biến môi trường. Điều này hữu ích cho thông tin nhạy cảm như khóa API.
* **networks**: Thiết lập network `langflow` để giao tiếp giữa các container dễ dàng hơn, hữu ích khi bạn có các service khác cần tương tác với Infinity API.

### Tham khảo

*   **Tài liệu API Infinity:** [https://github.com/michaelfeil/infinity](https://github.com/michaelfeil/infinity)
*   **Tài liệu Custom Components của Langflow:** [https://docs.langflow.org/components-custom-components](https://docs.langflow.org/components-custom-components)

```
